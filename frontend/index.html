<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRPG: Elodia</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>ChatRPG: <span id="world-name">Loading...</span></h1>
            <div class="header-controls">
                <div id="status" class="status-indicator" title="Server Status"></div>
            </div>
        </header>

        <!-- MAIN GRID LAYOUT -->
        <div class="main-grid">

            <!-- TOP LEFT: VIEW (Map or Portrait) -->
            <div class="grid-cell top-left" id="view-panel">
                <!-- Exploration View: Map -->
                <div id="exploration-view-content" class="view-content">
                    <div id="map-container">
                        <div id="game-map">
                            <!-- Map tiles generated here -->
                        </div>
                    </div>
                </div>

                <!-- Interaction View: Portrait -->
                <div id="interaction-view-content" class="view-content hidden">
                    <div class="portrait-wrapper">
                        <img id="character-portrait" src="" alt="Portrait">
                        <div id="portrait-placeholder" class="portrait-placeholder">?</div>
                    </div>
                </div>
            </div>

            <!-- TOP RIGHT: CONTEXT (Situation) -->
            <div class="grid-cell top-right" id="context-panel">
                <div class="panel-header">Situation</div>
                <div class="scrollable-content">
                    <!-- Exploration Context -->
                    <div id="exploration-context">
                        <div class="stat-card">
                            <h3>When</h3>
                            <div class="stat-row"><span>Time</span> <span>Day 1, Morning</span></div>
                        </div>
                        <div class="stat-card">
                            <h3>Where</h3>
                            <div class="stat-row"><span id="context-location">...</span></div>
                        </div>
                        <div class="stat-card">
                            <h3>Who & What</h3>
                            <div id="local-list" style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="color: #888; font-style: italic;">No one nearby.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Interaction Context -->
                    <div id="interaction-context" class="hidden">
                        <div class="stat-card">
                            <h3>Interaction</h3>
                            <div id="npc-details">
                                <h3 id="npc-name-display" style="color: var(--accent-color); margin:0;">Unknown</h3>
                                <p id="npc-desc-display" style="font-size: 0.9rem; color: #ccc; margin-top: 5px;">...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTTOM LEFT: LOG (Chat/History) -->
            <div class="grid-cell bottom-left" id="log-panel">
                <div class="panel-header">Log</div>
                <div id="chat-container" class="log-container">
                    <div class="message system">Welcome to ChatRPG. Initializing...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="main-input" placeholder="Type a command..." autocomplete="off">
                    <button class="btn" onclick="sendMainCommand()">Send</button>
                </div>
            </div>

            <!-- BOTTOM RIGHT: CONTROLS (Split: Nav | Actions) -->
            <div class="grid-cell bottom-right" id="controls-panel">
                <div class="panel-header">Controls</div>
                <div class="controls-content split-controls">
                    <!-- Left: Navigation (Hidden in Interaction) -->
                    <div id="nav-controls" class="control-half">
                        <div class="d-pad">
                            <button></button>
                            <button onclick="sendCommand('go north')">N</button>
                            <button></button>
                            <button onclick="sendCommand('go west')">W</button>
                            <button onclick="sendCommand('look')">üëÅÔ∏è</button>
                            <button onclick="sendCommand('go east')">E</button>
                            <button></button>
                            <button onclick="sendCommand('go south')">S</button>
                            <button></button>
                        </div>
                    </div>

                    <!-- Right: Actions -->
                    <div id="action-controls" class="control-half">
                        <!-- Exploration Actions -->
                        <div id="expl-actions">
                            <button class="btn" style="width: 100%; margin-bottom: 5px;"
                                onclick="sendCommand('inventory')">Inventory</button>
                            <button class="btn" style="width: 100%; background-color: #333; color: #fff;"
                                onclick="sendCommand('enter')">Enter</button>
                        </div>
                        <!-- Interaction Actions -->
                        <div id="int-actions" class="hidden">
                            <button class="btn btn-danger" style="width: 100%; margin-bottom: 10px;"
                                onclick="sendCommand('leave')">Leave</button>
                            <button class="btn" style="width: 100%; margin-bottom: 5px;"
                                onclick="sendCommand('trade')">Trade</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- State ---
        let sessionId = localStorage.getItem('gameSessionId');
        let currentGameMode = "EXPLORATION";

        // --- UI References ---
        const chatContainer = document.getElementById('chat-container');
        const mainInput = document.getElementById('main-input');

        // --- Initialization ---
        window.onload = async () => {
            if (!sessionId) {
                const playerName = prompt("Enter your character name:", "Traveler") || "Traveler";
                const res = await fetchFromServer('/start', { player_name: playerName });
                if (res) updateState(res);
            } else {
                // Rejoin
                const res = await fetchFromServer('/start', { session_id: sessionId }); // Using /start to rejoin/refresh
                if (res) updateState(res);
            }

            // Input listeners
            mainInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMainCommand();
            });
        };

        // --- API ---
        async function fetchFromServer(endpoint, body) {
            try {
                const res = await fetch(`http://localhost:8000${endpoint}`, {
                    method: body ? 'POST' : 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            } catch (err) {
                console.error(err);
                document.getElementById('status').className = 'status-indicator status-error';
                return null;
            }
        }

        // --- State Management ---
        async function updateState(data) {
            if (!data) return;

            // Update Session
            if (data.session_id) {
                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId);
            }

            // Update Game Mode
            const prevMode = currentGameMode;
            currentGameMode = data.game_mode || "EXPLORATION";

            // Update View Visibility
            updateViewVisibility(prevMode);

            // Update Common Stats (Removed from UI but data still available if needed)
            // const nameEls = ['player-name', 'player-name-int'];
            // const healthEls = ['player-health', 'player-health-int'];
            // const goldEls = ['player-gold', 'player-gold-int'];

            // nameEls.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = data.player_name; });
            // healthEls.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = data.health; });
            // goldEls.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = data.gold; });

            document.getElementById('world-name').textContent = data.world_name;
            if (document.getElementById('context-location')) document.getElementById('context-location').textContent = data.current_location;

            // Mode Specific Updates
            if (currentGameMode === "EXPLORATION") {
                updateExplorationState(data);
            } else {
                updateInteractionState(data);

                // Auto-Greeting Logic
                if (prevMode === "EXPLORATION" && !data.dialogue) {
                    sendInteractionCommand("Hello");
                }
            }

            document.getElementById('status').className = 'status-indicator status-ok';
        }

        function updateViewVisibility(prevMode) {
            const explContent = document.getElementById('exploration-view-content');
            const intContent = document.getElementById('interaction-view-content');
            const explContext = document.getElementById('exploration-context');
            const intContext = document.getElementById('interaction-context');

            const navControls = document.getElementById('nav-controls');
            const explActions = document.getElementById('expl-actions');
            const intActions = document.getElementById('int-actions');

            // Buttons to disable/enable
            const navButtons = navControls.querySelectorAll('button');
            const enterBtn = document.querySelector('#expl-actions button:last-child'); // Enter button

            if (currentGameMode === "EXPLORATION") {
                explContent.classList.remove('hidden');
                intContent.classList.add('hidden');
                explContext.classList.remove('hidden');
                intContext.classList.add('hidden');

                // Controls: Enable Nav
                navButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });

                // Enable Enter
                if (enterBtn) {
                    enterBtn.disabled = false;
                    enterBtn.style.opacity = '1';
                    enterBtn.style.cursor = 'pointer';
                }

                explActions.classList.remove('hidden');
                intActions.classList.add('hidden');

                mainInput.placeholder = "Type a command...";
            } else {
                explContent.classList.add('hidden');
                intContent.classList.remove('hidden');
                explContext.classList.add('hidden');
                intContext.classList.remove('hidden');

                // Controls: Disable Nav (don't hide)
                navButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                });

                // Disable Enter (if visible, but we are hiding explActions anyway... wait, user said "disable NEWS buttons instead of hiding")
                // User also said "Lock it" for Enter.
                // Currently explActions is hidden in Interaction. 
                // If we want to keep the structure, we should maybe NOT hide explActions but disable them?
                // "if the interface structure doesn't change whether we're in conversation or navigation"
                // Let's keep explActions visible but swap the buttons? Or just disable Enter?
                // The user said "disable the NEWS buttons instead of hiding them".
                // For Enter, "Better if we just locked it".
                // But we have "Leave" and "Trade" in Interaction.
                // So we swap the Action buttons (Expl vs Int) but keep Nav buttons visible (disabled).

                explActions.classList.add('hidden'); // We swap these for Leave/Trade
                intActions.classList.remove('hidden');

                mainInput.placeholder = "Say something...";
            }
        }

        function updateExplorationState(data) {
            // Map
            renderMap(data.map_display);

            // Local List
            const localList = document.getElementById('local-list');
            localList.innerHTML = '';
            if (data.npcs_in_location && data.npcs_in_location.length > 0) {
                data.npcs_in_location.forEach(npc => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.style.cursor = 'pointer';
                    card.style.transition = 'background 0.2s';

                    let locationText = "";
                    if (npc.distance === 0) {
                        locationText = "<span style='color:#4caf50'>Here</span>";
                    } else {
                        locationText = `<span style='color:#888'>${npc.distance} steps away</span>`;
                    }

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin: 0; color: var(--accent-color); border:none;">${npc.name}</h3>
                            <small>${locationText}</small>
                        </div>
                        <p style="font-size: 0.85rem; color: #ccc; margin-top:5px;">${npc.short_description}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn" style="font-size: 0.8rem; padding: 5px 10px; width:100%;" 
                                onclick="sendCommand('talk to ${npc.name}')">Talk</button>
                        </div>
                    `;
                    card.onmouseover = () => card.style.background = 'rgba(255, 255, 255, 0.1)';
                    card.onmouseout = () => card.style.background = 'rgba(255, 255, 255, 0.05)';
                    localList.appendChild(card);
                });
            } else {
                localList.innerHTML = '<div style="color: #888; font-style: italic;">No one nearby.</div>';
            }

            // Chat Log (System messages)
            if (data.dialogue) {
                addMessage(data.dialogue, 'system', chatContainer);
            }
        }

        function updateInteractionState(data) {
            // Portrait
            const portraitImg = document.getElementById('character-portrait');
            const placeholder = document.getElementById('portrait-placeholder');

            if (data.character_portrait && !data.character_portrait.endsWith('None.png')) {
                portraitImg.src = `http://localhost:8000${data.character_portrait}`;
                portraitImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                portraitImg.style.display = 'none';
                placeholder.style.display = 'flex';
            }

            // NPC Name in Context
            if (data.conversation_partner_name) {
                document.getElementById('npc-name-display').textContent = data.conversation_partner_name;
                // We could also update description if available, but name is most important.
                document.getElementById('npc-desc-display').textContent = "In conversation...";
            } else {
                document.getElementById('npc-name-display').textContent = "Unknown";
            }

            // Dialogue
            if (data.dialogue) {
                addMessage(data.dialogue, 'model', chatContainer);
            }
        }

        function renderMap(mapData) {
            const mapEl = document.getElementById('game-map');
            mapEl.innerHTML = '';

            if (!mapData || !mapData.grid) {
                mapEl.textContent = "No Map Data";
                return;
            }

            mapData.grid.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                row.forEach(cell => {
                    const tile = document.createElement('div');
                    tile.className = 'map-tile';
                    tile.textContent = cell.char;

                    if (cell.has_player) tile.classList.add('tile-player');
                    else if (cell.has_npc) tile.classList.add('tile-npc');
                    else if (cell.char === '#') tile.classList.add('tile-wall');
                    else if (cell.char === '.') tile.classList.add('tile-floor');
                    else tile.classList.add('tile-feature');

                    rowDiv.appendChild(tile);
                });
                mapEl.appendChild(rowDiv);
            });
        }

        function addMessage(text, type, container) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;

            // Format text
            let formattedText = text.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/"([^"]*)"/g, '<span class="dialogue-quote">"$1"</span>');

            msgDiv.innerHTML = formattedText;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- Commands ---
        async function sendCommand(cmd) {
            if (!cmd) return;

            // Optimistic UI update
            addMessage(cmd, 'user', chatContainer);

            let endpoint = '/command';
            let payload = { session_id: sessionId, command: cmd };

            const res = await fetchFromServer(endpoint, payload);
            if (res) updateState(res);
        }

        async function sendMainCommand() {
            const cmd = mainInput.value.trim();
            if (!cmd) return;
            mainInput.value = '';

            if (currentGameMode === "INTERACTION") {
                sendInteractionCommand(cmd);
            } else {
                sendCommand(cmd);
            }
        }

        async function sendInteractionCommand(msg) {
            if (!msg) return;
            // Optimistic UI
            addMessage(msg, 'user', chatContainer);
            const res = await fetchFromServer('/interact', { session_id: sessionId, message: msg });
            if (res) updateState(res);
        }

    </script>
</body>

</html>