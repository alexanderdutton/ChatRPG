<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRPG - Dark Fantasy</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>ChatRPG: <span id="world-name">Loading...</span></h1>
            <div class="header-controls">
                <div id="status" class="status-indicator" title="Server Status"></div>
            </div>
        </header>

        <!-- Left Sidebar: Stats -->
        <aside class="sidebar-left">
            <div class="stat-card">
                <h3>Character</h3>
                <div class="stat-row"><span>Name</span> <span id="player-name">...</span></div>
                <div class="stat-row"><span>Health</span> <span id="player-health">100</span></div>
                <div class="stat-row"><span>Gold</span> <span id="player-gold">0</span></div>
            </div>

            <div class="stat-card">
                <h3>Inventory</h3>
                <div id="player-inventory" style="font-size: 0.85rem; color: #aaa;">Empty</div>
            </div>

            <div class="stat-card">
                <h3>Quests</h3>
                <div id="quest-log" style="font-size: 0.85rem; color: #aaa;">None</div>
            </div>
        </aside>

        <!-- Main Content: Chat & Map -->
        <main class="main-content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chat')">Chat</button>
                <button class="tab-btn" onclick="switchTab('map')">Map</button>
            </div>

            <div id="tab-chat" class="tab-content active">
                <div id="chat-container">
                    <div class="message system">Welcome to ChatRPG. Initializing...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="chat-input" placeholder="Type a message or command..." autocomplete="off">
                    <button class="btn" id="send-btn">Send</button>
                </div>
            </div>

            <div id="tab-map" class="tab-content">
                <div id="map-container">
                    <div id="game-map">
                        <!-- Map tiles generated here -->
                    </div>
                </div>
                <div style="padding: 10px; text-align: center; color: #666;">
                    <small>Use Arrow Keys to Move</small>
                </div>
            </div>
        </main>

        <!-- Right Sidebar: Context & Actions -->
        <aside class="sidebar-right">
            <div class="portrait-container">
                <img id="character-portrait" src="" alt="Portrait" style="display: none;">
                <div id="portrait-placeholder"
                    style="display: flex; align-items: center; justify-content: center; height: 100%; color: #333;">
                    No Target
                </div>
            </div>

            <div class="stat-card">
                <h3>Navigation</h3>
                <div class="d-pad">
                    <button></button>
                    <button onclick="sendCommand('go north')">N</button>
                    <button></button>
                    <button onclick="sendCommand('go west')">W</button>
                    <button onclick="sendCommand('look')">üëÅÔ∏è</button>
                    <button onclick="sendCommand('go east')">E</button>
                    <button></button>
                    <button onclick="sendCommand('go south')">S</button>
                    <button></button>
                </div>
            </div>

            <div class="stat-card">
                <h3>Actions</h3>
                <button class="btn" style="width: 100%; margin-bottom: 5px;"
                    onclick="sendCommand('inventory')">Inventory</button>
                <button class="btn" style="width: 100%; background-color: #333; color: #fff;"
                    onclick="sendCommand('enter')">Enter/Exit</button>
            </div>
        </aside>
    </div>

    <script>
        // --- State ---
        let sessionId = localStorage.getItem('gameSessionId');
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');

        // --- UI Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function addMessage(text, type) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- API ---
        async function fetchFromServer(endpoint, body) {
            try {
                const res = await fetch(`http://localhost:8000${endpoint}`, {
                    method: body ? 'POST' : 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            } catch (err) {
                console.error(err);
                document.getElementById('status').className = 'status-indicator status-error';
                return null;
            }
        }

        async function updateState(data) {
            if (!data) return;

            // Update Session
            if (data.session_id) {
                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId);
            }

            // Update Stats
            document.getElementById('player-name').textContent = data.player_name;
            document.getElementById('player-health').textContent = data.health;
            document.getElementById('player-gold').textContent = data.gold;
            document.getElementById('world-name').textContent = data.world_name;
            document.getElementById('player-inventory').textContent = data.inventory.length ? data.inventory.join(', ') : 'Empty';
            document.getElementById('quest-log').textContent = data.quest_log.length ? data.quest_log.join(', ') : 'None';

            // Update Map
            renderMap(data.map_display);

            // Update Portrait
            const portraitImg = document.getElementById('character-portrait');
            const placeholder = document.getElementById('portrait-placeholder');
            if (data.character_portrait && data.character_portrait.includes('undefined') === false) {
                // Simple check to avoid bad URLs
                // Actually the backend returns /portraits/None.png if no NPC, so we should check data.npcs_in_location or similar context
                // For now, if we have a valid URL, try to show it.
                // But wait, the backend always returns a URL based on conversation partner.
                // If no conversation partner, it might be null or empty.
                if (data.character_portrait && !data.character_portrait.endsWith('None.png')) {
                    portraitImg.src = `http://localhost:8000${data.character_portrait}`;
                    portraitImg.style.display = 'block';
                    placeholder.style.display = 'none';
                } else {
                    portraitImg.style.display = 'none';
                    placeholder.style.display = 'flex';
                }
            }

            document.getElementById('status').className = 'status-indicator status-ok';
        }

        function renderMap(mapData) {
            const mapEl = document.getElementById('game-map');
            mapEl.innerHTML = '';
            if (!mapData || !mapData.grid) {
                mapEl.textContent = "No Map Data";
                return;
            }

            mapData.grid.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                row.forEach(cell => {
                    const tile = document.createElement('div');
                    tile.className = 'map-tile';
                    tile.textContent = cell.char;

                    // Simple styling logic
                    if (cell.has_player) tile.classList.add('tile-player');
                    else if (cell.has_npc) tile.classList.add('tile-npc');
                    else if (cell.char === '#') tile.classList.add('tile-wall');
                    else if (cell.char === '.') tile.classList.add('tile-floor');
                    else tile.classList.add('tile-feature');

                    rowDiv.appendChild(tile);
                });
                mapEl.appendChild(rowDiv);
            });
        }

        async function sendCommand(cmd) {
            if (!cmd) return;
            addMessage(cmd, 'user');

            // Check if it's a chat or a command
            // Simple heuristic: if it starts with specific keywords, it's a command.
            // Otherwise, if we are talking to someone, it's chat.
            // But the backend separates /interact and /command.
            // The original frontend had separate inputs.
            // Let's try to be smart.

            const commandKeywords = ['go ', 'look', 'inventory', 'enter', 'help'];
            const isCommand = commandKeywords.some(k => cmd.toLowerCase().startsWith(k));

            let endpoint = '/command';
            let payload = { session_id: sessionId, command: cmd };

            // If not a movement command, maybe it's chat?
            // For now, let's stick to the explicit buttons for commands and input for chat/custom commands.
            // If the user typed it, we'll try /command first.
            // Actually, the backend /command handles "talk to", so maybe everything can go through /command?
            // No, /command returns a string response, /interact returns LLM dialogue.

            // Let's use a simple toggle or just assume input is chat if we have a partner?
            // For simplicity in this version:
            // If it matches a command pattern, use /command.
            // Else use /interact.

            if (!isCommand) {
                endpoint = '/interact';
                payload = { session_id: sessionId, message: cmd };
            }

            const data = await fetchFromServer(endpoint, payload);
            if (data) {
                updateState(data);
                if (data.dialogue) addMessage(data.dialogue, 'npc');
            }
        }

        // --- Init ---
        document.getElementById('send-btn').addEventListener('click', () => {
            const txt = chatInput.value.trim();
            if (txt) {
                sendCommand(txt);
                chatInput.value = '';
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const txt = chatInput.value.trim();
                if (txt) {
                    sendCommand(txt);
                    chatInput.value = '';
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return; // Don't move if typing
            if (e.key === 'ArrowUp') sendCommand('go north');
            if (e.key === 'ArrowDown') sendCommand('go south');
            if (e.key === 'ArrowLeft') sendCommand('go west');
            if (e.key === 'ArrowRight') sendCommand('go east');
        });

        // Initial Load
        (async () => {
            addMessage("Connecting to server...", "system");
            const data = await fetchFromServer('/start', { session_id: sessionId });
            if (data) {
                updateState(data);
                addMessage(data.dialogue, 'npc');
            }
        })();

    </script>
</body>

</html>