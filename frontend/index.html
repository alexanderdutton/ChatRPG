<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRPG: Elodia</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>ChatRPG: <span id="world-name">Loading...</span></h1>
            <div class="header-controls">
                <div id="status" class="status-indicator" title="Server Status"></div>
            </div>
        </header>

        <!-- EXPLORATION MODE VIEW -->
        <div id="exploration-view" class="game-view">
            <!-- Left: Chat Log -->
            <div class="panel left-panel">
                <div class="panel-header">Log</div>
                <div id="chat-container" class="log-container">
                    <div class="message system">Welcome to ChatRPG. Initializing...</div>
                </div>
                <div class="input-area">
                    <input type="text" id="exploration-input" placeholder="Type a command..." autocomplete="off">
                    <button class="btn" onclick="sendExplorationCommand()">Send</button>
                </div>
            </div>

            <!-- Center: Map -->
            <div class="panel center-panel">
                <div id="map-container">
                    <div id="game-map">
                        <!-- Map tiles generated here -->
                    </div>
                </div>
                <div class="d-pad-container">
                    <div class="d-pad">
                        <button></button>
                        <button onclick="sendCommand('go north')">N</button>
                        <button></button>
                        <button onclick="sendCommand('go west')">W</button>
                        <button onclick="sendCommand('look')">üëÅÔ∏è</button>
                        <button onclick="sendCommand('go east')">E</button>
                        <button></button>
                        <button onclick="sendCommand('go south')">S</button>
                        <button></button>
                    </div>
                </div>
            </div>

            <!-- Right: Local Brief & Stats -->
            <div class="panel right-panel">
                <div class="stat-card">
                    <h3>Nearby</h3>
                    <div id="local-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="color: #888; font-style: italic;">No one is here.</div>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>Character</h3>
                    <div class="stat-row"><span>Name</span> <span id="player-name">...</span></div>
                    <div class="stat-row"><span>Health</span> <span id="player-health">100</span></div>
                    <div class="stat-row"><span>Gold</span> <span id="player-gold">0</span></div>
                </div>

                <div class="stat-card">
                    <h3>Actions</h3>
                    <button class="btn" style="width: 100%; margin-bottom: 5px;"
                        onclick="sendCommand('inventory')">Inventory</button>
                    <button class="btn" style="width: 100%; background-color: #333; color: #fff;"
                        onclick="sendCommand('enter')">Enter/Exit</button>
                </div>
            </div>
        </div>

        <!-- INTERACTION MODE VIEW -->
        <div id="interaction-view" class="game-view hidden">
            <!-- Left: Dialogue History -->
            <div class="panel left-panel">
                <div class="panel-header">Conversation</div>
                <div id="dialogue-container" class="log-container">
                    <!-- Dialogue history goes here -->
                </div>
            </div>

            <!-- Center: Portrait & Current Dialogue -->
            <div class="panel center-panel interaction-center">
                <div class="portrait-wrapper">
                    <img id="character-portrait" src="" alt="Portrait">
                </div>
                <div id="current-dialogue-bubble" class="dialogue-bubble">
                    <!-- Latest spoken text -->
                </div>
            </div>

            <!-- Right: Interaction Actions -->
            <div class="panel right-panel">
                <div class="stat-card">
                    <h3>Interaction</h3>
                    <button class="btn btn-danger" style="width: 100%; margin-bottom: 10px;"
                        onclick="sendCommand('leave')">Leave Conversation</button>
                    <button class="btn" style="width: 100%; margin-bottom: 5px;"
                        onclick="sendCommand('trade')">Trade</button>
                </div>
                <div class="input-area">
                    <input type="text" id="interaction-input" placeholder="Say something..." autocomplete="off">
                    <button class="btn" onclick="sendInteractionCommand()">Say</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State ---
        let sessionId = localStorage.getItem('gameSessionId');
        let currentGameMode = "EXPLORATION";

        // --- UI References ---
        const explorationView = document.getElementById('exploration-view');
        const interactionView = document.getElementById('interaction-view');

        const chatContainer = document.getElementById('chat-container');
        const dialogueContainer = document.getElementById('dialogue-container');

        const explorationInput = document.getElementById('exploration-input');
        const interactionInput = document.getElementById('interaction-input');

        // --- Initialization ---
        window.onload = async () => {
            if (!sessionId) {
                const playerName = prompt("Enter your character name:", "Traveler") || "Traveler";
                const res = await fetchFromServer('/start', { player_name: playerName });
                if (res) updateState(res);
            } else {
                // Rejoin
                const res = await fetchFromServer('/start', { session_id: sessionId }); // Using /start to rejoin/refresh
                if (res) updateState(res);
            }

            // Input listeners
            explorationInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendExplorationCommand();
            });
            interactionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendInteractionCommand();
            });
        };

        // --- API ---
        async function fetchFromServer(endpoint, body) {
            try {
                const res = await fetch(`http://localhost:8000${endpoint}`, {
                    method: body ? 'POST' : 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            } catch (err) {
                console.error(err);
                document.getElementById('status').className = 'status-indicator status-error';
                return null;
            }
        }

        // --- State Management ---
        async function updateState(data) {
            if (!data) return;

            // Update Session
            if (data.session_id) {
                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId);
            }

            // Update Game Mode
            currentGameMode = data.game_mode || "EXPLORATION";
            updateViewVisibility();

            // Update Common Stats
            document.getElementById('player-name').textContent = data.player_name;
            document.getElementById('player-health').textContent = data.health;
            document.getElementById('player-gold').textContent = data.gold;
            document.getElementById('world-name').textContent = data.world_name;

            // Mode Specific Updates
            if (currentGameMode === "EXPLORATION") {
                updateExplorationState(data);
            } else {
                updateInteractionState(data);
            }

            document.getElementById('status').className = 'status-indicator status-ok';
        }

        function updateViewVisibility() {
            if (currentGameMode === "EXPLORATION") {
                explorationView.classList.remove('hidden');
                interactionView.classList.add('hidden');
            } else {
                explorationView.classList.add('hidden');
                interactionView.classList.remove('hidden');
            }
        }

        function updateExplorationState(data) {
            // Map
            renderMap(data.map_display);

            // Local List
            const localList = document.getElementById('local-list');
            localList.innerHTML = '';
            if (data.npcs_in_location && data.npcs_in_location.length > 0) {
                data.npcs_in_location.forEach(npc => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.style.cursor = 'pointer';
                    card.style.transition = 'background 0.2s';
                    card.innerHTML = `
                        <h3 style="margin: 0; color: var(--accent-color);">${npc.name}</h3>
                        <p style="font-size: 0.9rem; color: #ccc;">${npc.short_description}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn" style="font-size: 0.8rem; padding: 5px 10px;" onclick="sendCommand('talk to ${npc.name}')">Talk</button>
                        </div>
                    `;
                    card.onmouseover = () => card.style.background = 'rgba(255, 255, 255, 0.1)';
                    card.onmouseout = () => card.style.background = 'rgba(255, 255, 255, 0.05)';
                    localList.appendChild(card);
                });
            } else {
                localList.innerHTML = '<div style="color: #888; font-style: italic;">No one is here.</div>';
            }

            // Chat Log (System messages)
            // Note: We don't clear the log, just append new messages if any.
            // But the backend doesn't return a "new message" field, it returns "dialogue".
            // In exploration mode, "dialogue" is usually the location description or command response.
            if (data.dialogue) {
                addMessage(data.dialogue, 'system', chatContainer);
            }
        }

        function updateInteractionState(data) {
            // Portrait
            const portraitImg = document.getElementById('character-portrait');
            if (data.character_portrait && !data.character_portrait.endsWith('None.png')) {
                portraitImg.src = `http://localhost:8000${data.character_portrait}`;
                portraitImg.style.display = 'block';
            } else {
                portraitImg.style.display = 'none';
            }

            // Current Dialogue Bubble
            const bubble = document.getElementById('current-dialogue-bubble');
            if (data.dialogue) {
                bubble.textContent = data.dialogue;
                // Also add to history
                addMessage(data.dialogue, 'model', dialogueContainer);
            }
        }

        function renderMap(mapData) {
            const mapEl = document.getElementById('game-map');
            mapEl.innerHTML = '';

            if (!mapData || !mapData.grid) {
                mapEl.textContent = "No Map Data";
                return;
            }

            mapData.grid.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'map-row';
                row.forEach(cell => {
                    const tile = document.createElement('div');
                    tile.className = 'map-tile';
                    tile.textContent = cell.char;

                    if (cell.has_player) tile.classList.add('tile-player');
                    else if (cell.has_npc) tile.classList.add('tile-npc');
                    else if (cell.char === '#') tile.classList.add('tile-wall');
                    else if (cell.char === '.') tile.classList.add('tile-floor');
                    else tile.classList.add('tile-feature');

                    rowDiv.appendChild(tile);
                });
                mapEl.appendChild(rowDiv);
            });
        }

        function addMessage(text, type, container) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- Commands ---
        async function sendCommand(cmd) {
            if (!cmd) return;

            // Determine endpoint based on mode
            // Actually, we can route everything through /command for simplicity, 
            // EXCEPT when we are "Saying" something in interaction mode, which is /interact.
            // But wait, /command handles "talk to" which initiates interaction.

            // If we are in INTERACTION mode and typing in the chat box, it's /interact.
            // If we click "Leave", it's a command "leave".

            let endpoint = '/command';
            let payload = { session_id: sessionId, command: cmd };

            // Optimistic UI update
            if (currentGameMode === "EXPLORATION") {
                addMessage(cmd, 'user', chatContainer);
            } else {
                addMessage(cmd, 'user', dialogueContainer);
            }

            const res = await fetchFromServer(endpoint, payload);
            if (res) updateState(res);
        }

        async function sendExplorationCommand() {
            const cmd = explorationInput.value.trim();
            if (!cmd) return;
            explorationInput.value = '';
            sendCommand(cmd);
        }

        async function sendInteractionCommand() {
            const msg = interactionInput.value.trim();
            if (!msg) return;
            interactionInput.value = '';

            // Use /interact endpoint for conversation
            addMessage(msg, 'user', dialogueContainer);
            const res = await fetchFromServer('/interact', { session_id: sessionId, message: msg });
            if (res) updateState(res);
        }

    </script>
</body>

</html>