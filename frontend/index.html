<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini NPC Game</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #dialogue-box {
            border: 1px solid #ddd;
            padding: 15px;
            height: 350px; /* Fixed height */
            overflow-y: auto; /* Added scrollbar */
            background-color: #e9e9e9;
            border-radius: 4px;
            flex: 1; /* Take up available space */
            margin-right: 10px; /* Space between dialogue and map */
        }
        .message { margin-bottom: 10px; }
        .user-message { text-align: right; color: #0056b3; }
        .npc-message { text-align: left; color: #28a745; }
        input[type="text"] { width: calc(100% - 80px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        button:hover { background-color: #0056b3; }
        .loading { color: #888; font-style: italic; }
        #status { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .status-ok { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }

        /* New styles for overall layout */
        .main-game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .top-row {
            display: flex;
            gap: 20px;
        }

        .bottom-row {
            display: flex;
            justify-content: space-between; /* Distribute items evenly */
            gap: 20px;
        }

        /* New styles for card display and layout */
        .game-state-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .game-state-card p {
            margin: 5px 0;
        }

        .game-interaction-area {
            display: flex;
            gap: 20px; /* Space between dialogue and map */
            margin-bottom: 15px;
        }

        .map-container {
            flex: 1;
        }

        /* D-pad styling */
        .d-pad-container {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 2px;
            width: 184px; /* 3 * 60px + 2 * 2px */
            margin: 20px auto;
            background-color: #333;
            border-radius: 10px;
            padding: 2px;
        }
        .d-pad-button {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .d-pad-button:hover {
            background-color: #777;
        }
        .d-pad-button:active {
            background-color: #999;
        }
        .d-pad-button.north { grid-area: 1 / 2 / 2 / 3; }
        .d-pad-button.west { grid-area: 2 / 1 / 3 / 2; }
        .d-pad-button.east { grid-area: 2 / 3 / 3 / 4; }
        .d-pad-button.south { grid-area: 3 / 2 / 4 / 3; }
        .d-pad-button.center { grid-area: 2 / 2 / 3 / 3; }

        /* Tab styles */
        .tabs { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
        .tablink { background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; }
        .tablink:hover { background-color: #ddd; }
        .tablink.active { background-color: #ccc; }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            border-radius: 8px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Hamburger menu icon */
        .hamburger-menu {
            font-size: 2em;
            cursor: pointer;
            margin-left: 10px;
        }

        /* New map tile styles */
        .map-tile {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-family: monospace;
        }

        .player-tile {
            background-color: #90ee90; /* Light green */
        }

        .npc-tile {
            background-color: #add8e6; /* Light blue */
        }

        .player-npc-tile {
            background-color: #9370db; /* Medium purple */
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>ChatRPG - <span id="world-name"></span></h1>
            <span class="hamburger-menu" onclick="openModal('dataGenerationModal')">â˜°</span>
            <div id="status">Checking server connection...</div>
        </div>

        <div class="main-game-area">
            <div class="top-row">
                <div class="map-container">
                    <div class="tabs">
                        <button class="tablink" onclick="openTab(event, 'map-tab')">Map</button>
                        <button class="tablink" onclick="openTab(event, 'character-tab')">Character</button>
                    </div>

                    <div id="map-tab" class="tabcontent" style="display:block">
                        <pre id="game-map" style="background-color: #e9e9e9; margin:0px;padding: 0px; border-radius: 4px; font-family: monospace; font-size: 2em;"></pre>
                    </div>

                    <div id="character-tab" class="tabcontent" style="display:none">
                        <div id="npc-list"></div>
                        <div id="character-interaction" style="display:none;">
                            <img id="character-portrait" src="" alt="Character Portrait" style="width: 100%; max-width: 300px; display: block; margin: 0 auto;">
                            <h3 id="character-name"></h3>
                            <div id="dialogue-input-container">
                                <input type="text" id="dialogue-input-character" placeholder="Type your message...">
                                <button id="dialogue-send-button-character">Send</button>
                            </div>
                            <button id="back-to-npc-list">Back</button>
                        </div>
                    </div>
                </div>
                <div id="dialogue-box">
                    <div class="npc-message message">Game: Welcome to Gemini NPC Game! Initializing...</div>
                </div>
            </div>

            <div class="bottom-row">
                <div class="commands-area">
                    <h2>Navigation</h2>
                    <div class="d-pad-container">
                        <button id="go-north-button" class="d-pad-button north">N</button>
                        <button id="go-west-button" class="d-pad-button west">W</button>
                        <button id="look-button" class="d-pad-button center">Look</button>
                        <button id="go-east-button" class="d-pad-button east">E</button>
                        <button id="go-south-button" class="d-pad-button south">S</button>
                    </div>
                </div>
                <div class="commands-area">
                    <h2>Other Commands</h2>
                    <div id="other-commands">
                        <button id="inventory-button">Inventory</button>
                        <button id="enter-exit-button">Enter/Exit</button>
                    </div>
                </div>
                <div id="game-state" class="game-state-card">
                    <p><strong>Player:</strong> <span id="player-name"></span></p>
                    <p><strong>Location:</strong> <span id="current-location"></span></p>
                    <p><strong>Health:</strong> <span id="player-health"></span></p>
                    <p><strong>Gold:</strong> <span id="player-gold"></span></p>
                    <p><strong>Inventory:</strong> <span id="player-inventory"></span></p>
                    <p><strong>Quests:</strong> <span id="quest-log"></span></p>
                </div>
            </div>
        </div>

    </div>

    <!-- The Modal -->
    <div id="dataGenerationModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('dataGenerationModal')">&times;</span>
            <h2>Generate New Game Data</h2>
            <p>Enter a request for Gemini to generate new character or location data, or select from existing content.</p>
            <input type="text" id="data-generation-input" placeholder="e.g., 'a grumpy dwarf' or 'a dark cave'">
            <button id="generate-data-button">Generate Data</button>

            <h3>Saved Worlds</h3>
            <div id="world-list"></div>
        </div>
    </div>

    <script>
        console.log("Frontend script started.");
        let sessionId = localStorage.getItem('gameSessionId'); // Persist session ID
        const dialogueBox = document.getElementById('dialogue-box');
        
        const statusBox = document.getElementById('status');
        const maxMessages = 50; // Maximum number of messages to display

        // New elements for data generation
        const dataGenerationInput = document.getElementById('data-generation-input');
        const generateDataButton = document.getElementById('generate-data-button');
        const worldListDiv = document.getElementById('world-list');

        // New elements for character interaction
        const characterTab = document.getElementById('character-tab');
        const npcListDiv = document.getElementById('npc-list');
        const characterInteractionDiv = document.getElementById('character-interaction');
        const characterPortrait = document.getElementById('character-portrait');
        const characterName = document.getElementById('character-name');
        const dialogueInputCharacter = document.getElementById('dialogue-input-character');
        const dialogueSendButtonCharacter = document.getElementById('dialogue-send-button-character');
        const backToNpcListButton = document.getElementById('back-to-npc-list');

        let currentNPCId = null; // To keep track of the NPC being conversed with

        // Command buttons
        const goNorthButton = document.getElementById('go-north-button');
        const goEastButton = document.getElementById('go-east-button');
        const goSouthButton = document.getElementById('go-south-button');
        const goWestButton = document.getElementById('go-west-button');
        const inventoryButton = document.getElementById('inventory-button');
        const lookButton = document.getElementById('look-button');
        const enterExitButton = document.getElementById('enter-exit-button');

        // Modal functions
        window.openModal = function(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'dataGenerationModal') {
                listWorlds(); // Load worlds when modal opens
            }
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function trimDialogueBox() {
            const messages = dialogueBox.querySelectorAll('.message');
            if (messages.length > maxMessages) {
                for (let i = 0; i < messages.length - maxMessages; i++) {
                    messages[i].remove();
                }
            }
        }

        // Function to toggle movement controls
        function toggleMovementControls(enable) {
            goNorthButton.disabled = !enable;
            goEastButton.disabled = !enable;
            goSouthButton.disabled = !enable;
            goWestButton.disabled = !enable;
            lookButton.disabled = !enable;
            enterExitButton.disabled = !enable;

            if (enable) {
                document.addEventListener('keydown', handleArrowKeys);
            } else {
                document.removeEventListener('keydown', handleArrowKeys);
            }
        }

        // Handle arrow key presses
        function handleArrowKeys(event) {
            switch (event.key) {
                case 'ArrowUp':
                    sendCommand('go north');
                    event.preventDefault();
                    break;
                case 'ArrowDown':
                    sendCommand('go south');
                    event.preventDefault();
                    break;
                case 'ArrowLeft':
                    sendCommand('go west');
                    event.preventDefault();
                    break;
                case 'ArrowRight':
                    sendCommand('go east');
                    event.preventDefault();
                    break;
            }
        }

        function updateMapDisplay(mapData) {
            const gameMap = document.getElementById('game-map');
            gameMap.innerHTML = ''; // Clear previous map

            if (!mapData || !mapData.grid) {
                gameMap.textContent = 'No map data available.';
                return;
            }

            mapData.grid.forEach(row => {
                const rowDiv = document.createElement('div');
                row.forEach(tile => {
                    const tileSpan = document.createElement('span');
                    tileSpan.textContent = tile.char;
                    tileSpan.className = 'map-tile';
                    if (tile.has_player && tile.has_npc) {
                        tileSpan.classList.add('player-npc-tile');
                    } else if (tile.has_player) {
                        tileSpan.classList.add('player-tile');
                    } else if (tile.has_npc) {
                        tileSpan.classList.add('npc-tile');
                    }
                    rowDiv.appendChild(tileSpan);
                });
                gameMap.appendChild(rowDiv);
            });
        }

        window.openTab = function(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // Toggle movement controls based on tab
            if (tabName === 'map-tab') {
                toggleMovementControls(true);
            } else {
                toggleMovementControls(false);
            }
        }

        async function checkServerStatus() {
            try {
                const response = await fetch('http://127.0.0.1:8000/health');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok') {
                        statusBox.textContent = 'Server Connection: OK';
                        statusBox.className = 'status-ok';
                        return;
                    }
                }
                throw new Error('Server status check failed');
            } catch (error) {
                console.error('Health check failed:', error);
                statusBox.textContent = 'Server Connection: FAILED. Please ensure the backend is running.';
                statusBox.className = 'status-error';
            }
        }

        async function sendDialogue(message) {
            if (!message || !currentNPCId) return; // Added check for currentNPCId

            // Display user message
            dialogueBox.innerHTML += `<div class="user-message message">You: ${message}</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight; // Scroll to bottom

            dialogueBox.innerHTML += `<div class="loading message">NPC is thinking...</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight;

            try {
                const response = await fetch('http://127.0.0.1:8000/interact', { // Adjust URL if your backend is elsewhere
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, message: message })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const data = await response.json();

                // Remove loading message
                const loadingMessage = dialogueBox.querySelector('.loading');
                if (loadingMessage) loadingMessage.remove();

                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId); // Save new session ID

                // Update game state display
                document.getElementById('player-name').textContent = data.player_name;
                document.getElementById('current-location').textContent = data.current_location;
                document.getElementById('player-health').textContent = data.health;
                document.getElementById('player-gold').textContent = data.gold;
                document.getElementById('player-inventory').textContent = data.inventory.join(', ');
                document.getElementById('quest-log').textContent = data.quest_log.join(', ');
                console.log("Map display data received (sendDialogue):", data.map_display);
                updateMapDisplay(data.map_display); // Update map display

                if (data.character_portrait) {
                    characterPortrait.src = data.character_portrait;
                    characterPortrait.style.display = 'block';
                } else {
                    characterPortrait.style.display = 'none';
                }

                // Display NPC message
                dialogueBox.innerHTML += `<div class="npc-message message">NPC: ${data.dialogue}</div>`;
                trimDialogueBox();
            } catch (error) {
                console.error('Error sending message:', error);
                const loadingMessage = dialogueBox.querySelector('.loading');
                if (loadingMessage) loadingMessage.remove();
                dialogueBox.innerHTML += `<div class="npc-message message" style="color: red;">NPC: I'm sorry, I couldn't connect right now. Please check the console for details.</div>`;
            } finally {
                // Re-enable buttons
                dialogueSendButtonCharacter.disabled = false;
                dialogueBox.scrollTop = dialogueBox.scrollHeight;
            }
        }

        async function sendCommand(command) {
            // Display user command
            dialogueBox.innerHTML += `<div class="user-message message">You: ${command}</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight; // Scroll to bottom

            // Disable buttons during command processing
            dialogueSendButtonCharacter.disabled = true;
            toggleMovementControls(false); // Disable movement controls during command processing

            dialogueBox.innerHTML += `<div class="loading message">Processing command...</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight;

            try {
                const response = await fetch('http://127.0.0.1:8000/command', { // New command endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, command: command })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const data = await response.json();

                // Remove loading message
                const loadingMessage = dialogueBox.querySelector('.loading');
                if (loadingMessage) loadingMessage.remove();

                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId); // Save new session ID

                // Update game state display
                document.getElementById('player-name').textContent = data.player_name;
                document.getElementById('current-location').textContent = data.current_location;
                document.getElementById('player-health').textContent = data.health;
                document.getElementById('player-gold').textContent = data.gold;
                document.getElementById('player-inventory').textContent = data.inventory.join(', ');
                document.getElementById('quest-log').textContent = data.quest_log.join(', ');
                console.log("Map display data received (sendCommand):", data.map_display);
                updateMapDisplay(data.map_display); // Update map display

                console.log("NPCs in location (sendCommand):", data.npcs_in_location);
                // Update NPC list if available
                if (data.npcs_in_location && data.npcs_in_location.length > 0) {
                    npcListDiv.innerHTML = '<h3>NPCs Here:</h3>';
                    data.npcs_in_location.forEach(npc => {
                        const npcButton = document.createElement('button');
                        npcButton.textContent = npc.name;
                        npcButton.onclick = () => startCharacterInteraction(npc.id, npc.name);
                        npcListDiv.appendChild(npcButton);
                    });
                    
                } else {
                    npcListDiv.innerHTML = '<p>No NPCs in this location.</p>';
                }

                // Display command response
                dialogueBox.innerHTML += `<div class="npc-message message">Game: ${data.dialogue}</div>`;
                trimDialogueBox();
            } catch (error) {
                console.error('Error sending command:', error);
                const loadingMessage = dialogueBox.querySelector('.loading');
                if (loadingMessage) loadingMessage.remove();
                dialogueBox.innerHTML += `<div class="npc-message message" style="color: red;">Game: Error processing command. Please check the console for details.</div>`;
            } finally {
                // Re-enable buttons
                dialogueSendButtonCharacter.disabled = false;
                // Re-enable movement controls after command processing, if map tab is active
                if (document.getElementById('map-tab').style.display === 'block') {
                    toggleMovementControls(true);
                }
                dialogueBox.scrollTop = dialogueBox.scrollHeight;
            }
        }
        
        // Add event listeners for command buttons
        goNorthButton.addEventListener('click', () => sendCommand('go north'));
        goEastButton.addEventListener('click', () => sendCommand('go east'));
        goSouthButton.addEventListener('click', () => sendCommand('go south'));
        goWestButton.addEventListener('click', () => sendCommand('go west'));
        inventoryButton.addEventListener('click', () => sendCommand('inventory'));
        lookButton.addEventListener('click', () => sendCommand('look'));
        enterExitButton.addEventListener('click', () => sendCommand('enter'));

        // New character interaction functions and event listeners
        async function startCharacterInteraction(npcId, npcName) {
            currentNPCId = npcId;
            characterName.textContent = npcName;
            npcListDiv.style.display = 'none';
            characterInteractionDiv.style.display = 'block';
            // Optionally load portrait here if not already loaded by backend response
            try {
                const portraitResponse = await fetch(`http://127.0.0.1:8000/npc_portrait/${npcId}`);
                if (portraitResponse.ok) {
                    const portraitData = await portraitResponse.json();
                    characterPortrait.src = portraitData.portrait_url;
                    characterPortrait.style.display = 'block';
                } else {
                    console.error('Error fetching portrait:', portraitResponse.statusText);
                    characterPortrait.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching portrait:', error);
                characterPortrait.style.display = 'none';
            }

            // Send command to backend to initiate dialogue
            await sendCommand(`talk to ${npcName}`);
        }

        backToNpcListButton.addEventListener('click', () => {
            currentNPCId = null;
            npcListDiv.style.display = 'block';
            characterInteractionDiv.style.display = 'none';
            characterPortrait.style.display = 'none';
            // Re-enable movement controls when returning to NPC list (which is part of map tab)
            if (document.getElementById('map-tab').style.display === 'block') {
                toggleMovementControls(true);
            }
        });

        dialogueSendButtonCharacter.addEventListener('click', () => {
            if (currentNPCId) {
                sendDialogue(dialogueInputCharacter.value.trim());
                dialogueInputCharacter.value = '';
            }
        });

        dialogueInputCharacter.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && currentNPCId) {
                sendDialogue(dialogueInputCharacter.value.trim());
                dialogueInputCharacter.value = '';
            }
        });

        async function initializeGame() {
            try {
                const response = await fetch('http://127.0.0.1:8000/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const data = await response.json();
                sessionId = data.session_id;
                localStorage.setItem('gameSessionId', sessionId);

                // Update UI with initial data
                dialogueBox.innerHTML += `<div class="npc-message message">Game: ${data.dialogue}</div>`;
                document.getElementById('player-name').textContent = data.player_name;
                document.getElementById('current-location').textContent = data.current_location;
                document.getElementById('player-health').textContent = data.health;
                document.getElementById('player-gold').textContent = data.gold;
                document.getElementById('player-inventory').textContent = data.inventory.join(', ');
                document.getElementById('quest-log').textContent = data.quest_log.join(', ');
                console.log("Map display data received (initializeGame):", data.map_display);
                updateMapDisplay(data.map_display); // Update map display
                document.getElementById('world-name').textContent = data.current_location; // Set world name in title

                console.log("NPCs in location (initializeGame):", data.npcs_in_location);
                if (data.npcs_in_location && data.npcs_in_location.length > 0) {
                    npcListDiv.innerHTML = '<h3>NPCs Here:</h3>';
                    data.npcs_in_location.forEach(npc => {
                        const npcButton = document.createElement('button');
                        npcButton.textContent = npc.name;
                        npcButton.onclick = () => startCharacterInteraction(npc.id, npc.name);
                        npcListDiv.appendChild(npcButton);
                    });
                } else {
                    npcListDiv.innerHTML = '<p>No NPCs in this location.</p>';
                }

                trimDialogueBox();
                toggleMovementControls(true); // Enable movement controls on initial load
            } catch (error) {
                console.error('Error initializing game:', error);
                dialogueBox.innerHTML += `<div class="npc-message message" style="color: red;">Game: Error initializing. Please check the console.</div>`;
            }
        }

        // Data generation functions
        async function listWorlds() {
            try {
                const response = await fetch('http://127.0.0.1:8000/list_worlds');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                worldListDiv.innerHTML = '';
                data.worlds.forEach(worldName => {
                    const button = document.createElement('button');
                    button.textContent = worldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    button.onclick = () => loadWorld(worldName);
                    worldListDiv.appendChild(button);
                });

            } catch (error) {
                console.error('Error listing worlds:', error);
                worldListDiv.innerHTML = '<p style="color: red;">Error loading worlds.</p>';
            }
        }

        async function loadWorld(worldName) {
            dialogueBox.innerHTML += `<div class="user-message message">Loading world: ${worldName}...</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight;

            try {
                const response = await fetch('http://127.0.0.1:8000/load_world', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ world_name: worldName })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const data = await response.json();
                dialogueBox.innerHTML += `<div class="npc-message message">Game: ${data.message}</div>`;
                trimDialogueBox();
                // Re-initialize game to load new data
                initializeGame();
                closeModal('dataGenerationModal'); // Close modal after loading world
            } catch (error) {
                console.error('Error loading world:', error);
                dialogueBox.innerHTML += `<div class="npc-message message" style="color: red;">Game: Error loading world. Please check the console for details.</div>`;
            } finally {
                dialogueBox.scrollTop = dialogueBox.scrollHeight;
            }
        }

        async function generateData(request = null) {
            const requestText = request || dataGenerationInput.value.trim();
            if (!requestText) return;

            dialogueBox.innerHTML += `<div class="user-message message">Generating data for: ${requestText}...</div>`;
            dialogueBox.scrollTop = dialogueBox.scrollHeight;

            try {
                const response = await fetch('http://127.0.0.1:8000/generate_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request: requestText })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const data = await response.json();
                dialogueBox.innerHTML += `<div class="npc-message message">Game: ${data.message}</div>`;
                trimDialogueBox();
                // Re-initialize game to load new data
                initializeGame();
                listWorlds(); // Refresh world list after generating new data
            } catch (error) {
                console.error('Error generating data:', error);
                dialogueBox.innerHTML += `<div class="npc-message message" style="color: red;">Game: Error generating data. Please check the console for details.</div>`;
            } finally {
                dataGenerationInput.value = '';
                dialogueBox.scrollTop = dialogueBox.scrollHeight;
            }
        }

        generateDataButton.addEventListener('click', () => generateData());
        dataGenerationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateData();
            }
        });

        // Check server status on page load
        checkServerStatus();

        // Ensure DOM is fully loaded before initializing game
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            // Start a simple python server to serve the file
            const port = 8001;
            const server = `python -m http.server ${port}`;
            const currentUrl = window.location.href;

            if (!currentUrl.includes(`http://localhost:${port}`)) {
                alert(`Starting server on port ${port}. Please refresh the page.`);
                // This is a bit of a hack, but it works for local development
                // In a real application, you would have a more robust solution
                fetch('/start-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: server })
                }).then(() => {
                    window.location.href = `http://localhost:${port}/frontend/index.html`;
                });
            } else {
                initializeGame();
                listWorlds(); // Load worlds on page load
            }
        });
    </script>
</body>
</html>